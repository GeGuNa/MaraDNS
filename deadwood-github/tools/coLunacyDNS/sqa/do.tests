#!/bin/sh

# We need to be root to bind to port 53
if ! id | grep root > /dev/null 2>&1 ; then
        echo the tests must be run as a root user
        exit 1
fi

if [ "$1" = "--help" ] ; then	
	echo Usage: $0 to run all tests 
	echo $0 --stop to stop if a test fails
	exit 0
fi

HERE="$(/bin/pwd)"
rm ../coLunacyDNS
cd ..
make clean
make CFLAGS="-g -DTEST"
echo coLunacyDNS compiled in test mode
cd "$HERE"

DoStop=""
if [ "$1" = "--stop" ] ; then
	DoStop="1"
fi

# Test underlying libs
TESTS="sqa_rg32"
TESTS=$TESTS" sqa_ip6Parse"
TESTS=$TESTS" sqa_halfsip13"
# Test Lua config files in README.md
TESTS=$TESTS" sqa_oneanswer"
TESTS=$TESTS" sqa_getupstream"
TESTS=$TESTS" sqa_twoanswers"
TESTS=$TESTS" sqa_twoupstreams"
TESTS=$TESTS" sqa_blocklist"
TESTS=$TESTS" sqa_servfail"
TESTS=$TESTS" sqa_ignoreme"
FAIL=""

for test in $TESTS ; do
	echo Test $test
	cd $test
	if ! ./do.test ; then
		FAIL=${FAIL}${test}" "
		if [ ! -z "$DoStop" ] ; then
			echo Stopping tests because of test failure
			exit 1
		fi
	fi
	cd "$HERE"
done
if [ -z "$FAIL" ] ; then
	cd "$HERE"
	cd ..
	make clean
	echo All tests successful
	exit 0
fi
echo Test failures: ${FAIL}
exit 1
